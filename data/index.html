<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Temperature Monitoring</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
  <style>
    body {
      margin: 0 auto;
      padding: 20px;
      max-width: 800px;
    }
    h2 {
      font-family: Arial, sans-serif;
      font-size: 2.5rem;
      text-align: center;
      margin-bottom: 20px;
    }
    .progress-bar {
      width: 100%;
      background-color: #f1f1f1;
      border: 1px solid #ccc;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .progress {
      width: 0;
      height: 30px;
      background-color: #4CAF50;
      text-align: center;
      line-height: 30px;
      color: white;
    }
    .form-control {
      border: 2px solid #0d6efd; /* Bootstrap primary button color */
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Fermenter 1</h2>
    <!--<div id="chart-temperature"></div>-->
    <div id="setpoint">Temperature: Waiting for updates...</div>
    <div id="tc1TempC">Humidity: Waiting for updates...</div>
    <div id="output">Output: Waiting for updates...</div>
    <div id="nextPumpCycleTime">Next Pump Cycle Time: Waiting for updates...</div>
    <div id="pumpStatus">Pump Status: Waiting for updates...</div>
    <div id="fermStatus">Ferm Status: Waiting for updates...</div>
    <form id="form1">
      <div class="mb-3 row">
        <label for="ferm1_Setpoint" class="col-sm-2 col-form-label">Setpoint</label>
        <div class="col-sm-10">
          <input type="number" step="0.01" min="0" max="40" id="ferm1_Setpoint" name="ferm1_Setpoint" class="form-control" oninput="setpointInputChanged(this.value)" onblur="setpointInputBlur()" style="width: 100px;">
        </div>
      </div>
      <div class="mb-3">
        <label for="ferm1_Status" class="form-label">Status</label>
        <button type="button" id="ferm1_Status" name="ferm1_Status" class="btn btn-secondary" onclick="toggleButton()">OFF</button>
      </div>
    </form>
    <div id="form1-response" class="mt-3"></div>
  </div>
  <script>
    updatingSetpoint = false;
    const ws = new WebSocket('wss://nodemcu.mikesbrewshop.com/ws');

    ws.onopen = function() {
      console.log('WebSocket connection established');
    };

    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      document.getElementById('setpoint').innerText = 'Setpoint: ' + data.setpoint.toFixed(2);
      document.getElementById('tc1TempC').innerText = 'Temperature: ' + data.tc1TempC;
      document.getElementById('output').innerText = 'Output: ' + data.output;
      document.getElementById('nextPumpCycleTime').innerText = 'Next Pump Cycle Time: ' + data.nextPumpCycleTime;
      document.getElementById('pumpStatus').innerText = 'Pump Status: ' + data.pumpStatus;
      document.getElementById('fermStatus').innerText = 'Ferm Status: ' + data.fermStatus;

      // Update form inputs with server values
      if (!updatingSetpoint) {
        document.getElementById('ferm1_Setpoint').value = data.setpoint.toFixed(2);
      }
      
      var button = document.getElementById('ferm1_Status');
      if (data.fermStatus === true) {
        button.innerText = 'ON';
        button.classList.remove('btn-secondary');
        button.classList.add('btn-success');
      } else {
        button.innerText = 'OFF';
        button.classList.remove('btn-success');
        button.classList.add('btn-secondary');
      }
    };

    ws.onclose = function() {
      console.log('WebSocket connection closed');
    };

    ws.onerror = function(error) {
      console.log('WebSocket error: ', error);
    };

    function sendData(inputName, inputValue) {
      if (inputName === 'ferm1_Setpoint' && (inputValue < 0 || inputValue > 40)) {
        alert('Setpoint must be between 0 and 40');
        return;
      }
      var xhr = new XMLHttpRequest();
      var url = "/post";
      var data = {};
      data[inputName] = inputValue;

      xhr.open("POST", url, true);
      xhr.setRequestHeader("Content-Type", "application/json");

      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          document.getElementById(inputName + "-response").innerHTML = xhr.responseText;
        }
      };
      xhr.send(JSON.stringify(data));
    }

    function toggleButton() {
      var button = document.getElementById("ferm1_Status");
      if (button.innerText === "OFF") {
        button.innerText = "ON";
        button.classList.remove("btn-secondary");
        button.classList.add("btn-success");
        sendData("ferm1_Status", "ON");
      } else {
        button.innerText = "OFF";
        button.classList.remove("btn-success");
        button.classList.add("btn-secondary");
        sendData("ferm1_Status", "OFF");
      }
    }

    // Fetch initial values from the server
    function fetchInitialValues() {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "/initial-values", true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          var data = JSON.parse(xhr.responseText);
          document.getElementById('ferm1_Setpoint').value = data.ferm1Setpoint;
          var button = document.getElementById('ferm1_Status');
          if (data.ferm1Status === 'ON') {
            button.innerText = 'ON';
            button.classList.remove('btn-secondary');
            button.classList.add('btn-success');
          } else {
            button.innerText = 'OFF';
            button.classList.remove('btn-success');
            button.classList.add('btn-secondary');
          }
        }
      };
      xhr.send();
    }

    document.addEventListener("DOMContentLoaded", function() {
      fetchInitialValues();
    });

    function setpointInputChanged(value) {
      updatingSetpoint = true; // User is actively editing setpoint
      sendData('ferm1_Setpoint', value)
    }

    function setpointInputBlur() {
      updatingSetpoint = false; // User has finished editing setpoint
    }
  </script>
</body>
</html>
