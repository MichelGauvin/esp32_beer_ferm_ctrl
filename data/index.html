<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Temperature Monitoring</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
  <style>
    body {
      margin: 0 auto;
      padding: 20px;
      max-width: 800px;
    }
    h2 {
      font-family: Arial, sans-serif;
      font-size: 2.5rem;
      text-align: center;
      margin-bottom: 20px;
    }
    .progress-bar {
      width: 100%;
      background-color: #f1f1f1;
      border: 1px solid #ccc;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .progress {
      width: 0;
      height: 30px;
      background-color: #4CAF50;
      text-align: center;
      line-height: 30px;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Temp&#233;rature Garage Michel</h2>
    <div id="chart-temperature"></div>
    <div class="mb-3">
      <label for="value" class="form-label">Current Value</label>
      <input id="value" class="form-control" type="text" readonly>
    </div>
    <form action="/get" target="hidden-form" class="mb-3">
      <div class="mb-3">
        <label for="inputFloat" class="form-label">Input Float (current value %inputFloat%)</label>
        <input type="number" name="inputFloat" id="inputFloat" class="form-control">
      </div>
      <button type="submit" class="btn btn-primary" onclick="submitMessage()">Submit</button>
    </form>
    <h1>Real-time Updates from NodeMCU</h1>
    <div id="setpoint">Temperature: Waiting for updates...</div>
    <div id="tc1TempC">Humidity: Waiting for updates...</div>
    <div id="output">Output: Waiting for updates...</div>
    <div id="nextPumpCycleTime">Next Pump Cycle Time: Waiting for updates...</div>
    <div id="pumpStatus">Pump Status: Waiting for updates...</div>
    <div id="fermStatus">Ferm Status: Waiting for updates...</div>
    <h1>Send Data to ESP</h1>
    <h2>Form 1</h2>
    <form id="form1" onsubmit="event.preventDefault(); sendData('form1');">
      <div class="mb-3">
        <label for="input1" class="form-label">Input 1</label>
        <input type="text" id="input1" name="input1" class="form-control">
      </div>
      <div class="mb-3">
        <label for="input2" class="form-label">Input 2</label>
        <input type="text" id="input2" name="input2" class="form-control">
      </div>
      <button type="submit" class="btn btn-primary">Send</button>
    </form>
    <div id="form1-response" class="mt-3"></div>
    <h2>Form 2</h2>
    <form id="form2" onsubmit="event.preventDefault(); sendData('form2');">
      <div class="mb-3">
        <label for="input3" class="form-label">Input 3</label>
        <input type="text" id="input3" name="input3" class="form-control">
      </div>
      <div class="mb-3">
        <label for="input4" class="form-label">Input 4</label>
        <input type="text" id="input4" name="input4" class="form-control">
      </div>
      <button type="submit" class="btn btn-primary">Send</button>
    </form>
    <div id="form2-response" class="mt-3"></div>
  </div>
  <script>
    var chartT = new Highcharts.Chart({
      chart: { renderTo: 'chart-temperature' },
      title: { text: 'Temp&#233;rature' },
      series: [{
        showInLegend: false,
        data: []
      }],
      plotOptions: {
        line: {
          animation: false,
          dataLabels: { enabled: false }
        },
        series: { color: '#059e8a' }
      },
      xAxis: { type: 'datetime', dateTimeLabelFormats: { second: '%H:%M:%S' } },
      time: { useUTC: false },
      yAxis: { title: { text: 'Temperature (Celsius)' } },
      credits: { enabled: false }
    });

    chartT.yAxis[0].setExtremes(8, 30);

    setInterval(function() {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          var x = (new Date()).getTime(),
              y = parseFloat(this.responseText);
          if (chartT.series[0].data.length > 600) {
            chartT.series[0].addPoint([x, y], true, true, true);
          } else {
            chartT.series[0].addPoint([x, y], true, false, true);
          }
          document.getElementById("value").value = y.toFixed(2);
        }
      };
      xhttp.open("GET", "/temperature", true);
      xhttp.send();
    }, 1000);

    const ws = new WebSocket('wss://nodemcu.mikesbrewshop.com/ws');

    ws.onopen = function() {
      console.log('WebSocket connection established');
    };

    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      document.getElementById('setpoint').innerText = 'Setpoint: ' + data.setpoint;
      document.getElementById('tc1TempC').innerText = 'Temperature: ' + data.tc1TempC;
      document.getElementById('output').innerText = 'Output: ' + data.output;
      document.getElementById('nextPumpCycleTime').innerText = 'Next Pump Cycle Time: ' + data.nextPumpCycleTime;
      document.getElementById('pumpStatus').innerText = 'Pump Status: ' + data.pumpStatus;
      document.getElementById('fermStatus').innerText = 'Ferm Status: ' + data.fermStatus;
    };

    ws.onclose = function() {
      console.log('WebSocket connection closed');
    };

    ws.onerror = function(error) {
      console.log('WebSocket error: ', error);
    };

    function sendData(formId) {
      var xhr = new XMLHttpRequest();
      var url = "/post";
      var form = document.getElementById(formId);
      var data = {};

      var inputs = form.getElementsByTagName('input');
      for (var i = 0; i < inputs.length; i++) {
        data[inputs[i].name] = inputs[i].value;
      }

      xhr.open("POST", url, true);
      xhr.setRequestHeader("Content-Type", "application/json");

      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          document.getElementById(formId + "-response").innerHTML = xhr.responseText;
        }
      };
      xhr.send(JSON.stringify(data));
    }
  </script>
</body>
</html>
